<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Catagotchi Â· Cuida a tu gato virtual</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light;
        --bg-primary: radial-gradient(circle at top, #ffe3f1 0%, #ffb7d5 36%, #ff86c6 70%, #f564a5 100%);
        --shell-main: #ff85c5;
        --shell-highlight: #ffd6ec;
        --shell-shadow: #d43c8c;
        --screen-sky: #bde9ff;
        --screen-ground: #ffe7b5;
        --screen-glow: rgba(255, 255, 255, 0.36);
        --screen-border: #ffbcd9;
        --hud-bg: rgba(255, 255, 255, 0.36);
        --hud-border: #ff9cca;
        --hud-text: #87245f;
        --stat-bg: rgba(255, 255, 255, 0.42);
        --stat-border: #ff87c9;
        --progress-bg: rgba(255, 255, 255, 0.5);
        --progress-fill: linear-gradient(90deg, #ff9bc6 0%, #ffda85 100%);
        --progress-fill-cool: linear-gradient(90deg, #8bc6ff 0%, #74f2ff 100%);
        --progress-fill-fun: linear-gradient(90deg, #f996ff 0%, #ffa4d4 100%);
        --text-primary: #53163c;
        --text-secondary: #a13a6f;
        --button-bg: #ffe5f3;
        --button-shadow: #ffa4d0;
        --device-shadow: rgba(218, 44, 129, 0.28);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-primary);
        font-family: "Poppins", sans-serif;
        color: var(--text-primary);
        padding: 32px 18px;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.4), transparent 55%),
          radial-gradient(circle at 80% 25%, rgba(255, 255, 255, 0.35), transparent 45%);
        pointer-events: none;
        opacity: 0.45;
      }

      main.device {
        position: relative;
        width: min(480px, 92vw);
        padding: 42px 34px 58px;
        border-radius: 220px 220px 280px 280px;
        background: radial-gradient(circle at 50% 18%, var(--shell-highlight), var(--shell-main) 55%, var(--shell-shadow) 120%);
        box-shadow: 0 40px 80px var(--device-shadow), inset 0 0 0 6px rgba(255, 255, 255, 0.4);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 18px;
      }

      main.device::before {
        content: "";
        position: absolute;
        inset: 16px 22px;
        border-radius: 180px 180px 240px 240px;
        border: 4px solid rgba(255, 255, 255, 0.45);
        pointer-events: none;
      }

      .status-strip {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 16px;
        padding: 12px 16px;
        border-radius: 22px;
        background: rgba(255, 255, 255, 0.45);
        border: 3px solid rgba(255, 255, 255, 0.65);
        box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.35);
        font-weight: 600;
        color: var(--text-secondary);
      }

      .identity {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
      }

      .identity-avatar {
        width: 48px;
        height: 48px;
        border-radius: 16px;
        background: rgba(255, 255, 255, 0.85);
        border: 2px solid rgba(255, 134, 201, 0.55);
        display: grid;
        place-items: center;
        font-size: 1.8rem;
        font-family: inherit;
        box-shadow: 0 6px 0 rgba(255, 118, 197, 0.35);
        flex-shrink: 0;
        appearance: none;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        line-height: 1;
        padding: 0;
        color: inherit;
        user-select: none;
      }

      .identity-avatar:focus-visible {
        outline: 2px solid rgba(89, 148, 255, 0.9);
        outline-offset: 3px;
      }

      .identity-avatar:active {
        transform: translateY(2px);
        box-shadow: 0 3px 0 rgba(255, 118, 197, 0.35);
      }

      .identity-meta {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
        align-items: flex-start;
      }

      .name-field {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-family: "Press Start 2P", system-ui;
        font-size: 0.54rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .name-field input {
        border: none;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        padding: 6px 8px 4px;
        font: inherit;
        color: var(--text-primary);
        width: 118px;
        max-width: 100%;
        text-transform: uppercase;
      }

      .name-field input::placeholder {
        color: rgba(122, 54, 88, 0.55);
      }

      .name-field input:focus {
        outline: 2px solid rgba(255, 118, 197, 0.75);
        outline-offset: 2px;
      }

      .level-pill {
        align-self: flex-start;
        font-family: "Press Start 2P", system-ui;
        font-size: 0.56rem;
        letter-spacing: 0.08em;
        background: rgba(255, 255, 255, 0.78);
        color: var(--text-primary);
        padding: 4px 9px 3px;
        border-radius: 999px;
        border: 2px solid rgba(255, 118, 197, 0.45);
        box-shadow: 0 4px 0 rgba(255, 118, 197, 0.35);
      }

      .screen-section {
        width: 100%;
      }

      .screen {
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 18px;
        background: linear-gradient(180deg, var(--screen-sky) 0%, var(--screen-ground) 70%);
        border-radius: 36px;
        border: 4px solid var(--screen-border);
        box-shadow: inset 0 0 0 3px rgba(255, 255, 255, 0.6), inset 0 0 45px var(--screen-glow);
        padding: 20px 18px 18px;
        font-family: "Press Start 2P", system-ui;
        letter-spacing: 0.05em;
        color: var(--hud-text);
      }

      .day-switch {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        border-radius: 999px;
        padding: 8px 12px 6px;
        font: inherit;
        font-size: 0.62rem;
        text-transform: uppercase;
        background: rgba(255, 255, 255, 0.4);
        border: 2px solid rgba(255, 255, 255, 0.7);
        color: inherit;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .day-switch:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 0 rgba(255, 118, 197, 0.35);
      }

      .day-switch:focus-visible {
        outline: 2px solid rgba(89, 148, 255, 0.8);
        outline-offset: 2px;
      }

      .scene {
        position: relative;
        height: clamp(260px, 48vw, 320px);
        border-radius: 28px;
        overflow: hidden;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.45) 0%, rgba(255, 255, 255, 0.05) 60%, transparent 100%);
        border: 2px dashed rgba(255, 255, 255, 0.4);
      }

      .scene::before,
      .scene::after {
        content: "";
        position: absolute;
        inset: 0;
        pointer-events: none;
      }

      .scene::before {
        background: radial-gradient(circle at 20% 25%, rgba(255, 255, 255, 0.7), transparent 60%),
          radial-gradient(circle at 85% 18%, rgba(255, 255, 255, 0.5), transparent 55%);
        opacity: 0.75;
      }

      .scene::after {
        bottom: -14px;
        top: auto;
        height: 160px;
        background: repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.32) 0 2px, transparent 2px 8px);
        opacity: 0.5;
      }

      .scene-floor {
        position: absolute;
        inset: auto 0 0;
        height: 42%;
        background: linear-gradient(180deg, rgba(255, 229, 184, 0.7), rgba(255, 190, 150, 0.4));
        border-top: 2px solid rgba(255, 255, 255, 0.6);
      }

      .cat-wanderer {
        --x: 0px;
        --y: 0px;
        --flip: 1;
        --scale: 1;
        --bob-speed: 3.2s;
        --shadow-opacity: 0.45;
        position: absolute;
        left: 50%;
        bottom: 32px;
        width: clamp(150px, 38vw, 208px);
        transform: translate(calc(-50% + var(--x)), var(--y));
        transition: transform 2.4s cubic-bezier(0.55, 0, 0.25, 1);
        will-change: transform;
      }

      .cat-shadow {
        position: absolute;
        left: 50%;
        bottom: -14px;
        width: 70%;
        height: 26px;
        background: rgba(0, 0, 0, 0.18);
        border-radius: 50%;
        transform: translateX(-50%) scaleX(calc(0.95 + (var(--scale) - 1) * 0.6));
        filter: blur(4px);
        opacity: var(--shadow-opacity);
        transition: transform 2.4s cubic-bezier(0.55, 0, 0.25, 1), opacity 0.6s ease;
      }

      .cat {
        position: relative;
        width: 100%;
        transform: scaleX(var(--flip)) scale(var(--scale));
        transform-origin: center bottom;
        animation: bob var(--bob-speed) ease-in-out infinite;
        filter: drop-shadow(0 10px 18px rgba(112, 41, 104, 0.25));
      }

      .cat svg {
        width: 100%;
        height: auto;
      }

      .cat[data-mood="feliz"] svg {
        filter: saturate(1.1) brightness(1.05) drop-shadow(0 10px 18px rgba(112, 41, 104, 0.25));
      }

      .cat[data-mood="triste"] svg,
      .cat[data-mood="enfadado"] svg {
        filter: saturate(0.85) brightness(0.92) drop-shadow(0 10px 18px rgba(112, 41, 104, 0.2));
      }

      .screen-hud {
        background: var(--hud-bg);
        border: 3px solid var(--hud-border);
        border-radius: 24px;
        padding: 14px 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.35);
      }

      .hud-top {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
      }

      .mood-chip {
        padding: 6px 12px 5px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.75);
        border: 2px solid rgba(255, 118, 197, 0.45);
        font-size: 0.65rem;
        letter-spacing: 0.08em;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .xp-bar {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.62rem;
        text-transform: uppercase;
      }

      .progress-track {
        flex: 1;
        height: 10px;
        border-radius: 999px;
        background: var(--progress-bg);
        border: 2px solid rgba(255, 255, 255, 0.7);
        overflow: hidden;
      }

      .progress-fill {
        width: var(--value, 50%);
        height: 100%;
        background: var(--progress-fill);
        border-radius: inherit;
        transition: width 0.6s ease;
      }

      .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
        font-size: 0.58rem;
      }

      .stat {
        position: relative;
        padding: 10px 12px 12px;
        border-radius: 18px;
        background: var(--stat-bg);
        border: 2px solid var(--stat-border);
        box-shadow: inset 0 0 8px rgba(255, 255, 255, 0.28);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .stat[data-theme="cool"] .progress-fill {
        background: var(--progress-fill-cool);
      }

      .stat[data-theme="fun"] .progress-fill {
        background: var(--progress-fill-fun);
      }

      .stat-title {
        display: flex;
        justify-content: space-between;
        text-transform: uppercase;
      }

      .stat-value {
        position: absolute;
        top: 10px;
        right: 12px;
      }

      .progress-bar {
        width: 100%;
        height: 9px;
        border-radius: 999px;
        border: 2px solid rgba(255, 255, 255, 0.7);
        background: var(--progress-bg);
        overflow: hidden;
      }

      .activity-log {
        max-height: 180px;
        overflow-y: auto;
        display: grid;
        gap: 10px;
        font-family: "Poppins", sans-serif;
        font-size: 0.85rem;
        color: var(--text-primary);
      }

      .log-window {
        width: 100%;
        background: rgba(255, 255, 255, 0.48);
        border-radius: 26px;
        border: 3px solid rgba(255, 255, 255, 0.7);
        padding: 18px 18px 20px;
        box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.32);
      }

      .log-title {
        font-family: "Press Start 2P", system-ui;
        font-size: 0.72rem;
        letter-spacing: 0.08em;
        margin: 0 0 14px;
        text-transform: uppercase;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .log-entry {
        background: rgba(255, 255, 255, 0.78);
        border: 2px dashed rgba(255, 134, 201, 0.65);
        border-radius: 16px;
        padding: 10px 12px;
        display: grid;
        gap: 6px;
      }

      .log-time {
        font-family: "Press Start 2P", system-ui;
        font-size: 0.55rem;
        letter-spacing: 0.08em;
        color: rgba(130, 52, 92, 0.7);
      }

      .log-text {
        line-height: 1.45;
      }

      .button-row {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(48px, 1fr));
        gap: 18px;
        justify-items: center;
        margin: 4px 0 0;
      }

      .device-button {
        position: relative;
        width: 58px;
        height: 58px;
        border-radius: 50%;
        border: none;
        background: var(--button-bg);
        box-shadow: 0 10px 0 var(--button-shadow);
        display: grid;
        place-items: center;
        font-size: 1.8rem;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .device-button::after {
        content: attr(data-label);
        position: absolute;
        bottom: -28px;
        left: 50%;
        transform: translateX(-50%) translateY(4px);
        background: rgba(255, 255, 255, 0.82);
        color: var(--text-primary);
        font-family: "Press Start 2P", system-ui;
        font-size: 0.48rem;
        padding: 4px 6px;
        border-radius: 6px;
        border: 1px solid rgba(255, 134, 201, 0.5);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        white-space: nowrap;
      }

      .device-button:hover,
      .device-button:focus-visible {
        transform: translateY(2px);
        box-shadow: 0 6px 0 var(--button-shadow);
      }

      .device-button:hover::after,
      .device-button:focus-visible::after {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      .device-button:active {
        transform: translateY(6px);
        box-shadow: 0 4px 0 var(--button-shadow);
      }

      .device-button:focus-visible {
        outline: 2px solid rgba(89, 148, 255, 0.8);
        outline-offset: 3px;
      }

      .toast {
        position: fixed;
        left: 50%;
        bottom: 24px;
        transform: translate(-50%, 120%);
        background: rgba(255, 255, 255, 0.92);
        color: var(--text-primary);
        border-radius: 18px;
        border: 2px solid rgba(255, 134, 201, 0.6);
        padding: 12px 16px;
        display: inline-flex;
        gap: 10px;
        align-items: center;
        font-weight: 600;
        box-shadow: 0 20px 32px rgba(215, 64, 150, 0.25);
        transition: transform 0.4s ease;
        z-index: 10;
      }

      .toast.show {
        transform: translate(-50%, 0);
      }

      .toast span:first-child {
        font-size: 1.4rem;
      }

      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }

      body[data-mode="night"] {
        --bg-primary: radial-gradient(circle at top, #2b1b68 0%, #1d0f51 42%, #10063a 75%, #040019 100%);
        --screen-sky: #2e3c8c;
        --screen-ground: #4d2d7a;
        --screen-glow: rgba(122, 162, 255, 0.2);
        --screen-border: #8f88ff;
        --hud-bg: rgba(24, 18, 61, 0.55);
        --hud-border: rgba(141, 129, 255, 0.6);
        --hud-text: #e2dcff;
        --stat-bg: rgba(39, 29, 84, 0.65);
        --stat-border: rgba(165, 153, 255, 0.55);
        --progress-bg: rgba(255, 255, 255, 0.35);
        --text-primary: #f6f4ff;
        --text-secondary: #c7c1ff;
        --button-bg: #ede9ff;
        --button-shadow: #a29dff;
        color: var(--text-primary);
      }

      body[data-mode="night"] .scene::before {
        background: radial-gradient(circle at 20% 24%, rgba(255, 255, 255, 0.35), transparent 50%),
          radial-gradient(circle at 70% 20%, rgba(255, 255, 255, 0.4), transparent 45%),
          radial-gradient(circle at 40% 18%, rgba(255, 255, 255, 0.35), transparent 45%);
        opacity: 0.5;
      }

      body[data-mode="night"] .scene::after {
        background: repeating-linear-gradient(0deg, rgba(255, 255, 255, 0.25) 0 2px, transparent 2px 7px);
        opacity: 0.35;
      }

      body[data-mode="night"] .cat-shadow {
        background: rgba(6, 2, 30, 0.4);
      }


      body[data-mode="night"] .log-window {
        background: rgba(24, 18, 61, 0.65);
        border: 3px solid rgba(141, 129, 255, 0.55);
      }

      body[data-mode="night"] .log-entry {
        background: rgba(35, 26, 80, 0.85);
        border-color: rgba(170, 158, 255, 0.55);
        color: var(--text-primary);
      }

      body[data-mode="night"] .log-time {
        color: rgba(212, 206, 255, 0.75);
      }

      body[data-mode="night"] .device-button::after {
        background: rgba(32, 24, 74, 0.85);
        color: #f6f4ff;
        border-color: rgba(170, 158, 255, 0.55);
      }

      body[data-mode="night"] .toast {
        background: rgba(29, 21, 68, 0.92);
        color: var(--text-primary);
        border-color: rgba(141, 129, 255, 0.55);
        box-shadow: 0 20px 32px rgba(37, 23, 85, 0.4);
      }

      @media (max-width: 520px) {
        main.device {
          padding: 34px 24px 48px;
        }

        .stat-grid {
          grid-template-columns: 1fr;
        }

        .screen {
          padding: 18px 14px 16px;
        }

        .name-field input {
          width: 100px;
        }

        .device-button::after {
          bottom: -24px;
        }
      }

      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.4);
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, rgba(255, 134, 201, 0.8), rgba(255, 214, 138, 0.9));
        border-radius: 999px;
      }

      @keyframes bob {
        0%,
        100% {
          transform: scaleX(var(--flip)) scale(var(--scale)) translateY(0);
        }
        50% {
          transform: scaleX(var(--flip)) scale(calc(var(--scale) + 0.02)) translateY(-6px);
        }
      }

      @media (max-width: 520px) {
        body {
          padding: 16px 12px;
        }

        main.device {
          width: min(360px, 100%);
          max-height: calc(100vh - 20px);
          padding: 28px 20px 36px;
          border-radius: 180px 180px 220px 220px;
          gap: 14px;
        }

        main.device::before {
          inset: 12px 18px;
          border-radius: 160px 160px 200px 200px;
        }

        .status-strip {
          gap: 12px;
          padding: 10px 14px;
        }

        .identity {
          gap: 10px;
        }

        .identity-avatar {
          width: 42px;
          height: 42px;
          border-radius: 14px;
          font-size: 1.5rem;
        }

        .name-field {
          font-size: 0.5rem;
        }

        .name-field input {
          width: 108px;
          padding: 5px 7px 4px;
        }

        .level-pill {
          font-size: 0.5rem;
          padding: 4px 8px 3px;
        }

        .screen {
          padding: 16px 14px;
          gap: 14px;
        }

        .day-switch {
          font-size: 0.55rem;
          padding: 6px 9px 5px;
        }

        .scene {
          height: clamp(210px, 60vw, 260px);
          border-radius: 24px;
        }

        .screen-hud {
          padding: 12px 12px;
          gap: 12px;
        }

        .hud-top {
          gap: 10px;
        }

        .mood-chip {
          font-size: 0.58rem;
          padding: 5px 10px 4px;
        }

        .xp-bar {
          font-size: 0.56rem;
          gap: 8px;
        }

        .progress-track {
          height: 9px;
        }

        .stat-grid {
          gap: 10px;
          font-size: 0.52rem;
        }

        .stat {
          padding: 9px 10px 11px;
        }

        .log-window {
          padding: 14px;
        }

        .log-title {
          font-size: 0.64rem;
          margin-bottom: 12px;
        }

        .activity-log {
          max-height: 120px;
          font-size: 0.78rem;
        }

        .button-row {
          gap: 14px;
          margin-top: 4px;
        }

        .device-button {
          width: 52px;
          height: 52px;
          box-shadow: 0 8px 0 var(--button-shadow);
          font-size: 1.6rem;
        }

        .device-button::after {
          bottom: -24px;
          font-size: 0.45rem;
        }
      }

      @media (max-width: 360px) {
        body {
          padding: 14px 10px;
        }

        main.device {
          max-width: 320px;
          padding: 24px 18px 32px;
          gap: 12px;
        }

        .name-field input {
          width: 96px;
        }

        .identity-avatar {
          width: 38px;
          height: 38px;
          border-radius: 12px;
        }

        .screen {
          padding: 14px 12px;
        }

        .scene {
          height: clamp(185px, 64vw, 230px);
        }

        .activity-log {
          max-height: 110px;
        }
      }

      @media (max-height: 680px) {
        body {
          padding: 12px 10px;
        }

        main.device {
          max-height: calc(100vh - 16px);
          gap: 12px;
        }

        .screen {
          gap: 12px;
        }

        .scene {
          height: clamp(170px, 52vh, 220px);
        }

        .screen-hud {
          gap: 10px;
        }

        .activity-log {
          max-height: 100px;
        }
      }

    </style>
  </head>
  <body data-mode="day">
    <main class="device">
      <section class="screen-section" aria-labelledby="panel-estado">
        <div class="screen" role="region" aria-live="polite">
          <div class="status-strip">
            <div class="identity">
              <button
                class="identity-avatar"
                id="identityAvatar"
                type="button"
                aria-label="Cambiar estilo del gato"
                title="Cambiar estilo del gato"
              >
                ðââ¬
              </button>
              <div class="identity-meta">
                <label class="name-field" for="catName">
                  <span>Nombre</span>
                  <input id="catName" maxlength="16" placeholder="LUKIS" />
                </label>
                <span class="level-pill" aria-live="polite">Nv. <strong id="level-label">1</strong></span>
              </div>
            </div>
            <button class="day-switch" id="daySwitch" type="button" aria-label="Cambiar entorno">
              <span id="dayEmoji">ð</span>
              <span id="dayLabel">Parque soleado</span>
            </button>
          </div>
          <div class="scene" id="catScene">
            <div class="scene-floor"></div>
            <div class="cat-wanderer" id="catWanderer">
              <div class="cat-shadow"></div>
              <div class="cat" id="cat" data-mood="feliz">
                <svg viewBox="0 0 240 240" role="img" aria-label="Gato virtual">
                  <defs>
                    <radialGradient id="furMain" cx="50%" cy="30%" r="75%">
                      <stop offset="0%" stop-color="#4f5662" />
                      <stop offset="55%" stop-color="#242832" />
                      <stop offset="100%" stop-color="#0e1118" />
                    </radialGradient>
                    <radialGradient id="furBelly" cx="50%" cy="40%" r="75%">
                      <stop offset="0%" stop-color="#ffffff" />
                      <stop offset="100%" stop-color="#e8edf5" />
                    </radialGradient>
                    <radialGradient id="faceMask" cx="50%" cy="50%" r="70%">
                      <stop offset="0%" stop-color="#ffffff" />
                      <stop offset="100%" stop-color="#eef2f7" />
                    </radialGradient>
                    <linearGradient id="tailGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" stop-color="#505867" />
                      <stop offset="100%" stop-color="#181c25" />
                    </linearGradient>
                    <radialGradient id="earInner" cx="50%" cy="50%" r="70%">
                      <stop offset="0%" stop-color="#ffd6e6" />
                      <stop offset="100%" stop-color="#f1a7c5" />
                    </radialGradient>
                    <radialGradient id="cheekGradient" cx="50%" cy="50%" r="50%">
                      <stop offset="0%" stop-color="#ffd1dc" />
                      <stop offset="100%" stop-color="#f9a6bf" />
                    </radialGradient>
                  </defs>
                  <g id="tail">
                    <path
                      d="M170 158 C202 150 212 122 198 98 C186 76 156 76 136 94"
                      fill="none"
                      stroke="url(#tailGradient)"
                      stroke-width="18"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M170 158 C190 160 204 148 208 132"
                      fill="none"
                      stroke="rgba(255, 255, 255, 0.45)"
                      stroke-width="6"
                      stroke-linecap="round"
                    />
                  </g>
                  <g id="cat-body">
                    <path
                      d="M66 134 C44 158 50 198 86 214 C120 230 170 220 190 186 C204 162 198 124 172 106 C150 90 124 92 102 100 C86 106 74 118 66 134 Z"
                      fill="url(#furMain)"
                      stroke="#1f2230"
                      stroke-width="4"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M94 152 C82 172 92 200 120 208 C150 216 174 198 176 170 C178 144 156 128 132 128 C116 128 102 136 94 152 Z"
                      fill="url(#furBelly)"
                      stroke="rgba(255, 255, 255, 0.6)"
                      stroke-width="2"
                    />
                  </g>
                  <g id="head">
                    <path
                      d="M86 72 L66 40 L102 56 Z"
                      fill="url(#furMain)"
                      stroke="#1f2230"
                      stroke-width="4"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M178 72 L198 40 L162 56 Z"
                      fill="url(#furMain)"
                      stroke="#1f2230"
                      stroke-width="4"
                      stroke-linejoin="round"
                    />
                    <path d="M86 72 L74 52 L100 62 Z" fill="url(#earInner)" opacity="0.75" />
                    <path d="M178 72 L190 52 L164 62 Z" fill="url(#earInner)" opacity="0.75" />
                    <path
                      d="M74 124 C70 92 92 60 126 56 C162 52 194 78 194 116 C194 146 172 170 140 170 C108 170 84 150 74 124 Z"
                      fill="url(#furMain)"
                      stroke="#1f2230"
                      stroke-width="4"
                      stroke-linejoin="round"
                    />
                  </g>
                  <g id="face" transform="translate(0,-18)">
                    <path
                      d="M96 98 C86 120 90 150 112 170 C130 186 154 188 172 172 C194 154 200 124 190 100 C180 76 154 66 128 72 C112 76 102 86 96 98 Z"
                      fill="url(#faceMask)"
                      stroke="rgba(255, 255, 255, 0.75)"
                      stroke-width="3"
                      stroke-linejoin="round"
                    />
                    <ellipse cx="120" cy="150" rx="20" ry="24" fill="#ffffff" opacity="0.95" />
                    <ellipse cx="168" cy="150" rx="20" ry="24" fill="#ffffff" opacity="0.95" />
                    <circle class="pupil" cx="120" cy="154" r="9" fill="#0e1018" />
                    <circle class="pupil" cx="168" cy="154" r="9" fill="#0e1018" />
                    <circle cx="116" cy="148" r="3" fill="#ffffff" opacity="0.75" />
                    <circle cx="164" cy="148" r="3" fill="#ffffff" opacity="0.75" />
                    <path
                      d="M132 148 L140 158 L148 148 Z"
                      fill="#f3b7c9"
                      stroke="#c67c8f"
                      stroke-width="2"
                      stroke-linejoin="round"
                    />
                    <path
                      id="mouth"
                      d="M130 172 Q144 184 158 172"
                      fill="none"
                      stroke="#c67c8f"
                      stroke-width="4"
                      stroke-linecap="round"
                    />
                    <circle cx="108" cy="166" r="9" fill="url(#cheekGradient)" opacity="0.65" />
                    <circle cx="180" cy="166" r="9" fill="url(#cheekGradient)" opacity="0.65" />
                    <path
                      d="M92 150 Q110 146 128 150"
                      fill="none"
                      stroke="#1f2230"
                      stroke-width="3"
                      stroke-linecap="round"
                    />
                    <path
                      d="M160 150 Q178 146 196 150"
                      fill="none"
                      stroke="#1f2230"
                      stroke-width="3"
                      stroke-linecap="round"
                    />
                    <path
                      d="M94 162 Q114 158 134 164"
                      fill="none"
                      stroke="rgba(31, 34, 48, 0.55)"
                      stroke-width="3"
                      stroke-linecap="round"
                    />
                    <path
                      d="M154 164 Q174 158 194 162"
                      fill="none"
                      stroke="rgba(31, 34, 48, 0.55)"
                      stroke-width="3"
                      stroke-linecap="round"
                    />
                  </g>
                  <g id="accessory" opacity="0">
                    <path
                      d="M96 176 C118 170 142 170 164 176 L156 194 C140 188 120 188 104 194 Z"
                      fill="#6ee7ff"
                      stroke="#4aa5ff"
                      stroke-width="3"
                      stroke-linejoin="round"
                    />
                  </g>
                </svg>
              </div>
            </div>
          </div>
          <div class="button-row">
            <button class="device-button" data-action="feed" data-label="Comer" aria-label="Alimentar">ð£</button>
            <button class="device-button" data-action="play" data-label="Jugar" aria-label="Jugar">ð§¶</button>
            <button class="device-button" data-action="nap" data-label="Siesta" aria-label="Tomar una siesta">ð´</button>
          </div>
          <div class="screen-hud">
            <div class="hud-top">
              <div class="mood-chip" id="moodLabel">â¨ Feliz</div>
              <div class="xp-bar">
                <span>XP</span>
                <div class="progress-track"><div class="progress-fill" id="xpBar"></div></div>
              </div>
            </div>
            <div class="stat-grid">
              <article class="stat" data-tooltip="Panza llena">
                <div class="stat-title">
                  <span>Panza</span>
                  <span class="stat-value" id="hungerValue">80%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="hungerBar"></div></div>
              </article>
              <article class="stat" data-theme="cool">
                <div class="stat-title">
                  <span>EnergÃ­a</span>
                  <span class="stat-value" id="energyValue">80%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="energyBar"></div></div>
              </article>
              <article class="stat" data-theme="fun">
                <div class="stat-title">
                  <span>Ãnimo</span>
                  <span class="stat-value" id="funValue">80%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="funBar"></div></div>
              </article>
            </div>
          </div>
        </div>
      </section>
      <section class="log-window" aria-live="polite">
        <h2 class="log-title">Diario</h2>
        <div class="activity-log" id="log"></div>
      </section>
    </main>

    <div class="toast" id="toast" role="status" aria-live="polite">
      <span id="toastEmoji"></span>
      <span id="toastMessage"></span>
    </div>

    <template id="logEntryTemplate">
      <article class="log-entry">
        <div class="log-time"></div>
        <div class="log-text"></div>
      </article>
    </template>

    <script>
      const STORAGE_KEY = "catagotchi-state-v2";
      const MIN_STAT = 0;
      const MAX_STAT = 100;
      const catNameInput = document.getElementById("catName");
      const levelLabel = document.getElementById("level-label");
      const daySwitch = document.getElementById("daySwitch");
      const dayEmoji = document.getElementById("dayEmoji");
      const dayLabel = document.getElementById("dayLabel");
      const catScene = document.getElementById("catScene");
      const catWanderer = document.getElementById("catWanderer");
      const cat = document.getElementById("cat");
      const identityAvatar = document.getElementById("identityAvatar");
      const gradientRefs = {
        furMain: document.getElementById("furMain"),
        furBelly: document.getElementById("furBelly"),
        faceMask: document.getElementById("faceMask"),
        tailGradient: document.getElementById("tailGradient"),
        earInner: document.getElementById("earInner"),
        cheekGradient: document.getElementById("cheekGradient"),
      };
      const pupilElements = document.querySelectorAll(".pupil");
      const hungerBar = document.getElementById("hungerBar");
      const hungerValue = document.getElementById("hungerValue");
      const energyBar = document.getElementById("energyBar");
      const energyValue = document.getElementById("energyValue");
      const funBar = document.getElementById("funBar");
      const funValue = document.getElementById("funValue");
      const xpBar = document.getElementById("xpBar");
      const moodLabel = document.getElementById("moodLabel");
      const toast = document.getElementById("toast");
      const toastEmoji = document.getElementById("toastEmoji");
      const toastMessage = document.getElementById("toastMessage");
      const log = document.getElementById("log");
      const logEntryTemplate = document.getElementById("logEntryTemplate");

      let currentSkinIndex = 0;
      let lastMoodKey = null;

      const catSkins = [
        {
          id: "lukis",
          name: "Lukis",
          emoji: "ðââ¬",
          colors: {
            furMain: ["#4f5662", "#242832", "#0e1118"],
            furBelly: ["#f4f7ff", "#d6dbea"],
            faceMask: ["#ffffff", "#eef2f7"],
            tailGradient: ["#505867", "#181c25"],
            earInner: ["#ffd6e6", "#f1a7c5"],
            cheekGradient: ["#ffd1dc", "#f9a6bf"],
            pupil: "#0e1018",
          },
        },
        {
          id: "arwen",
          name: "Arwen",
          emoji: "ð",
          colors: {
            furMain: ["#e0e5ef", "#b5bdc9", "#848d9c"],
            furBelly: ["#ffffff", "#e8edf5"],
            faceMask: ["#f4f7fb", "#dce2ec"],
            tailGradient: ["#c7ceda", "#8f97a5"],
            earInner: ["#ffe0ee", "#f5bcd4"],
            cheekGradient: ["#ffd7e4", "#f7abc6"],
            pupil: "#1a1c26",
          },
        },
        {
          id: "iria",
          name: "Iria",
          emoji: "ðââ¬",
          colors: {
            furMain: ["#f8e8d3", "#e0c3a3", "#b88760"],
            furBelly: ["#fff3e5", "#f1d6b6"],
            faceMask: ["#a26a47", "#5d3923"],
            tailGradient: ["#b88963", "#533726"],
            earInner: ["#f9c6ad", "#e29a76"],
            cheekGradient: ["#ffc7b2", "#f3997f"],
            pupil: "#221510",
          },
        },
      ];

      const defaultProgressBySkin = catSkins.reduce((acc, skin) => {
        acc[skin.id] = { level: 1, xp: 0 };
        return acc;
      }, {});

      const defaultState = {
        name: catSkins[0].name,
        hunger: 80,
        energy: 80,
        fun: 80,
        xp: 0,
        level: 1,
        lastTick: Date.now(),
        history: [],
        accessoriesUnlocked: false,
        dayMode: "day",
        skin: catSkins[0].id,
        progressBySkin: structuredClone(defaultProgressBySkin),
      };

      const state = loadState();

      if (!state.skin || !catSkins.some((skin) => skin.id === state.skin)) {
        state.skin = catSkins[0].id;
      }

      currentSkinIndex = catSkins.findIndex((skin) => skin.id === state.skin);
      if (currentSkinIndex === -1) {
        currentSkinIndex = 0;
        state.skin = catSkins[0].id;
      }

      if (!state.name || state.name === "Pixel") {
        state.name = catSkins[currentSkinIndex].name;
      }

      loadSkinProgress(state.skin);

      const actions = {
        feed: {
          emoji: "ð£",
          text: () => `${getName()} disfruta del mejor salmÃ³n nigiri.`,
          effects: { hunger: +26, fun: +6, energy: -4 },
          xp: 12,
        },
        play: {
          emoji: "ð§¶",
          text: () => `${getName()} persigue el ovillo como si fuera la Ãºltima vez.`,
          effects: { fun: +24, energy: -12, hunger: -8 },
          xp: 16,
        },
        nap: {
          emoji: "ð´",
          text: () => `${getName()} ronronea mientras duerme la siesta.`,
          effects: { energy: +32, hunger: -8, fun: -4 },
          xp: 10,
        },
      };

      const soundEngine = createSoundEngine();
      const soundPatterns = {
        feed: () => [
          { freq: 420, duration: 0.12, type: "triangle", volume: 0.6 },
          { freq: 260, duration: 0.12, type: "square", volume: 0.5, delay: 0.04 },
          { freq: 520, duration: 0.16, type: "square", volume: 0.45, delay: 0.02 },
        ],
        play: () => [
          { freq: 680, duration: 0.1, type: "square", volume: 0.6 },
          { freq: 820, duration: 0.14, type: "square", volume: 0.52, delay: 0.05, slide: -160 },
          { freq: 760, duration: 0.12, type: "square", volume: 0.46, delay: 0.03 },
        ],
        nap: () => [
          { freq: 180, duration: 0.52, type: "sine", volume: 0.38 },
          { freq: 150, duration: 0.58, type: "sine", volume: 0.34, delay: 0.32 },
        ],
        meow: () => [
          { freq: 520, duration: 0.14, type: "triangle", volume: 0.6, slide: 180 },
          { freq: 430, duration: 0.2, type: "triangle", volume: 0.55, delay: 0.06, slide: -220 },
        ],
        purr: () =>
          Array.from({ length: 6 }, (_, index) => ({
            freq: 90 + (index % 2 === 0 ? 8 : -8),
            duration: 0.18,
            type: "sine",
            volume: 0.32,
            delay: index === 0 ? 0 : 0.04,
          })),
      };

      function playSoundEffect(effectKey) {
        if (!soundEngine) return;
        const generator = soundPatterns[effectKey];
        if (!generator) return;
        const pattern = typeof generator === "function" ? generator() : generator;
        if (!Array.isArray(pattern) || pattern.length === 0) return;
        soundEngine.playPattern(pattern);
      }

      function playActionSound(actionKey) {
        switch (actionKey) {
          case "feed":
            playSoundEffect("feed");
            playSoundEffect("purr");
            break;
          case "nap":
            playSoundEffect("nap");
            playSoundEffect("purr");
            break;
          case "play":
            playSoundEffect("play");
            playSoundEffect("meow");
            break;
          default:
            playSoundEffect("meow");
        }
      }

      function playMoodSound(moodKey) {
        if (moodKey === "feliz") {
          playSoundEffect("purr");
        } else if (moodKey === "triste" || moodKey === "enfadado") {
          playSoundEffect("meow");
        }
      }

      const baseDegradeRates = {
        hunger: -2.5,
        energy: -2,
        fun: -2.3,
      };

      let degradeRates = { ...baseDegradeRates };
      const tickInterval = 2500;
      let wanderIntervalId;
      const catMotion = { x: 0, y: 0 };

      initialize();
      setInterval(tick, tickInterval);

      function setGradientStops(id, colors = []) {
        const gradient = gradientRefs[id];
        if (!gradient) return;
        const stops = gradient.querySelectorAll("stop");
        stops.forEach((stop, index) => {
          if (colors[index]) {
            stop.setAttribute("stop-color", colors[index]);
          }
        });
      }

      function applyCatSkinVisuals(skin) {
        if (!skin) return;
        setGradientStops("furMain", skin.colors.furMain);
        setGradientStops("furBelly", skin.colors.furBelly);
        setGradientStops("faceMask", skin.colors.faceMask);
        setGradientStops("tailGradient", skin.colors.tailGradient);
        setGradientStops("earInner", skin.colors.earInner);
        setGradientStops("cheekGradient", skin.colors.cheekGradient);
        if (skin.colors.pupil) {
          pupilElements.forEach((pupil) => pupil.setAttribute("fill", skin.colors.pupil));
        }
        if (identityAvatar) {
          identityAvatar.textContent = skin.emoji;
          identityAvatar.setAttribute("aria-label", `Cambiar estilo del gato (actual: ${skin.name})`);
          identityAvatar.setAttribute("title", `${skin.name} Â· Toca para cambiar de estilo`);
        }
        cat.dataset.skin = skin.id;
        if (catNameInput) {
          catNameInput.setAttribute("placeholder", skin.name.toUpperCase());
        }
      }

      function getCurrentSkinId() {
        return catSkins[currentSkinIndex]?.id || state.skin;
      }

      function ensureSkinProgress(skinId) {
        if (!skinId) return { level: 1, xp: 0 };
        if (!state.progressBySkin) {
          state.progressBySkin = structuredClone(defaultProgressBySkin);
        }
        if (!state.progressBySkin[skinId]) {
          state.progressBySkin[skinId] = { level: 1, xp: 0 };
        }
        return state.progressBySkin[skinId];
      }

      function loadSkinProgress(skinId) {
        const progress = ensureSkinProgress(skinId);
        state.level = Math.max(1, Math.floor(Number(progress.level) || 1));
        state.xp = Math.max(0, Number(progress.xp) || 0);
      }

      function persistSkinProgress(skinId = getCurrentSkinId()) {
        if (!skinId) return;
        ensureSkinProgress(skinId);
        state.progressBySkin[skinId] = {
          level: state.level,
          xp: state.xp,
        };
      }

      function setSkin(index, options = {}) {
        const { preserveName = false, announce = false } = options;
        if (catSkins.length === 0) return;
        const previousSkinId = getCurrentSkinId();
        if (previousSkinId) {
          persistSkinProgress(previousSkinId);
        }
        currentSkinIndex = ((index % catSkins.length) + catSkins.length) % catSkins.length;
        const skin = catSkins[currentSkinIndex];
        state.skin = skin.id;
        loadSkinProgress(state.skin);
        applyCatSkinVisuals(skin);
        if (!preserveName) {
          state.name = skin.name;
          catNameInput.value = skin.name;
        } else if (catNameInput && catNameInput.value.trim() === "") {
          catNameInput.value = state.name;
        }
        updateUI();
        if (announce) {
          pushLog(`${skin.name} estrena un nuevo pelaje.`, "ðº");
          showToast("ðº", `Ahora cuidas a ${skin.name}.`);
        } else {
          saveState();
        }
      }

      function cycleCatSkin() {
        const nextIndex = (currentSkinIndex + 1) % catSkins.length;
        setSkin(nextIndex, { announce: true });
      }

      function initialize() {
        setSkin(currentSkinIndex, { preserveName: true });
        catNameInput.value = state.name;
        catNameInput.addEventListener("change", () => {
          const fallbackName = catSkins[currentSkinIndex]?.name ?? catSkins[0].name;
          state.name = catNameInput.value.trim() || fallbackName;
          saveState();
          pushLog(`Ahora se llama ${state.name}.`, "â¨");
        });

        document.querySelectorAll(".device-button").forEach((btn) => {
          btn.addEventListener("click", () => handleAction(btn.dataset.action));
        });

        daySwitch.addEventListener("click", toggleDayMode);
        if (identityAvatar) {
          identityAvatar.addEventListener("click", cycleCatSkin);
        }

        if (state.history.length === 0) {
          pushLog(`Comienza una nueva aventura con ${state.name}.`, "ð");
        } else {
          state.history.forEach((entry) => addLogEntry(entry));
        }

        updateUI();
        updateDayMode();
        startCatWander();
      }

      function loadState() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (!stored) return structuredClone(defaultState);
          const parsed = JSON.parse(stored);
          const merged = { ...structuredClone(defaultState), ...parsed };
          const { clean, health, vetCooldown, ...safeState } = merged;
          const baseProgress = structuredClone(defaultProgressBySkin);
          const storedProgress = parsed?.progressBySkin || merged.progressBySkin || {};
          const fallbackLevel = Math.max(1, Math.floor(Number(parsed?.level ?? merged.level ?? 1)));
          const fallbackXp = Math.max(0, Number(parsed?.xp ?? merged.xp ?? 0));
          Object.entries(storedProgress || {}).forEach(([skinId, progress]) => {
            if (!progress) return;
            const level = Math.max(1, Math.floor(Number(progress.level) || 1));
            const xp = Math.max(0, Number(progress.xp) || 0);
            baseProgress[skinId] = { level, xp };
          });
          catSkins.forEach((skin) => {
            if (!baseProgress[skin.id]) {
              baseProgress[skin.id] = { level: 1, xp: 0 };
            }
          });
          safeState.progressBySkin = baseProgress;
          const desiredSkinId = safeState.skin && baseProgress[safeState.skin] ? safeState.skin : catSkins[0].id;
          if (!storedProgress || !storedProgress[desiredSkinId]) {
            baseProgress[desiredSkinId] = {
              level: fallbackLevel,
              xp: fallbackXp,
            };
          }
          const activeSkinId = desiredSkinId;
          safeState.skin = activeSkinId;
          safeState.level = baseProgress[activeSkinId].level;
          safeState.xp = baseProgress[activeSkinId].xp;
          return safeState;
        } catch (error) {
          console.error("Error cargando estado", error);
          return structuredClone(defaultState);
        }
      }

      function saveState() {
        try {
          persistSkinProgress();
          const copy = { ...state, history: state.history.slice(-25) };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(copy));
        } catch (error) {
          console.error("Error guardando estado", error);
        }
      }

      function tick() {
        const now = Date.now();
        const delta = (now - state.lastTick) / 1000;
        state.lastTick = now;

        Object.entries(degradeRates).forEach(([stat, rate]) => {
          modifyStat(stat, rate * delta);
        });

        if (state.hunger < 30) {
          modifyStat("fun", -1.4 * delta);
        }
        if (state.energy < 25) {
          modifyStat("fun", -1 * delta);
        }
        if (state.fun < 25) {
          modifyStat("energy", -0.8 * delta);
        }

        updateUI();
        saveState();
      }

      function modifyStat(stat, amount) {
        state[stat] = clamp(state[stat] + amount, MIN_STAT, MAX_STAT);
      }

      function handleAction(actionKey) {
        const action = actions[actionKey];
        if (!action) return;

        let effects = action.effects;
        if (typeof effects === "function") {
          effects = effects();
        }

        Object.entries(effects).forEach(([stat, value]) => modifyStat(stat, value));
        playActionSound(actionKey);
        gainXp(action.xp);
        const narration = action.text();
        addLogEntry({ emoji: action.emoji, message: narration, timestamp: Date.now() });

        if (!state.accessoriesUnlocked && state.level >= 3) {
          state.accessoriesUnlocked = true;
          toggleAccessory(true);
          pushLog(`${getName()} desbloquea su primer accesorio exclusivo.`, "ð");
        }

        const mood = getMood();
        cat.dataset.mood = mood.key;
        showToast(action.emoji, narration);
        updateUI();
        saveState();
        wanderCat(true);
      }

      function gainXp(amount) {
        state.xp = Math.max(0, state.xp + amount);
        const levelThreshold = state.level * 120;
        if (state.xp >= levelThreshold) {
          state.xp -= levelThreshold;
          state.level += 1;
          pushLog(`${getName()} sube al nivel ${state.level}.`, "ð");
          showToast("ð", `${getName()} alcanza el nivel ${state.level}.`);
        }
        persistSkinProgress();
      }

      function getMood() {
        const avg = (state.hunger + state.energy + state.fun) / 3;
        if (avg > 80) return { key: "feliz", label: "â¨ Feliz" };
        if (avg > 60) return { key: "contento", label: "ðº Contento" };
        if (avg > 40) return { key: "neutro", label: "ð Pensativo" };
        if (avg > 20) return { key: "triste", label: "ð¥º TristÃ³n" };
        return { key: "enfadado", label: "ð¾ Enfadado" };
      }

      function updateUI() {
        updateStat(hungerBar, hungerValue, state.hunger);
        updateStat(energyBar, energyValue, state.energy);
        updateStat(funBar, funValue, state.fun);
        updateXP();

        const mood = getMood();
        moodLabel.textContent = mood.label;
        cat.dataset.mood = mood.key;
        updateCatFace(mood.key);
        if (lastMoodKey && lastMoodKey !== mood.key) {
          playMoodSound(mood.key);
        }
        lastMoodKey = mood.key;
        levelLabel.textContent = state.level;
        document.title = `${getName()} Â· Nivel ${state.level} | Catagotchi`;
      }

      function updateStat(bar, valueLabel, statValue) {
        bar.style.setProperty("--value", `${statValue}%`);
        bar.style.width = `${statValue}%`;
        valueLabel.textContent = `${Math.round(statValue)}%`;
        if (statValue < 30) {
          valueLabel.style.color = "#ff4770";
        } else if (statValue > 70) {
          valueLabel.style.color = "#2eab6f";
        } else {
          valueLabel.style.color = "inherit";
        }
      }

      function updateXP() {
        const levelThreshold = state.level * 120;
        const xpPercent = Math.min(100, (state.xp / levelThreshold) * 100);
        xpBar.style.setProperty("--value", `${xpPercent}%`);
        xpBar.style.width = `${xpPercent}%`;
      }

      function updateCatFace(moodKey) {
        const mouth = document.getElementById("mouth");
        const pupils = pupilElements;
        switch (moodKey) {
          case "feliz":
            mouth.setAttribute("d", "M126 168 Q144 186 162 168");
            pupils.forEach((p) => p.setAttribute("cy", "152"));
            catWanderer.style.setProperty("--scale", "1.05");
            catWanderer.style.setProperty("--bob-speed", "2.4s");
            catWanderer.style.setProperty("--shadow-opacity", "0.5");
            break;
          case "contento":
            mouth.setAttribute("d", "M130 172 Q144 182 158 172");
            pupils.forEach((p) => p.setAttribute("cy", "154"));
            catWanderer.style.setProperty("--scale", "1");
            catWanderer.style.setProperty("--bob-speed", "2.8s");
            catWanderer.style.setProperty("--shadow-opacity", "0.45");
            break;
          case "neutro":
            mouth.setAttribute("d", "M132 172 Q144 172 156 172");
            pupils.forEach((p) => p.setAttribute("cy", "156"));
            catWanderer.style.setProperty("--scale", "0.98");
            catWanderer.style.setProperty("--bob-speed", "3.2s");
            catWanderer.style.setProperty("--shadow-opacity", "0.4");
            break;
          case "triste":
            mouth.setAttribute("d", "M132 176 Q144 166 156 176");
            pupils.forEach((p) => p.setAttribute("cy", "160"));
            catWanderer.style.setProperty("--scale", "0.96");
            catWanderer.style.setProperty("--bob-speed", "3.6s");
            catWanderer.style.setProperty("--shadow-opacity", "0.35");
            break;
          default:
            mouth.setAttribute("d", "M130 178 Q144 160 158 178");
            pupils.forEach((p) => p.setAttribute("cy", "164"));
            catWanderer.style.setProperty("--scale", "0.94");
            catWanderer.style.setProperty("--bob-speed", "3.8s");
            catWanderer.style.setProperty("--shadow-opacity", "0.32");
        }
      }

      function addLogEntry(entry) {
        const element = logEntryTemplate.content.cloneNode(true);
        const timeElement = element.querySelector(".log-time");
        const textElement = element.querySelector(".log-text");
        const date = new Date(entry.timestamp || Date.now());
        const time = date.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit" });
        timeElement.textContent = `${entry.emoji} ${time}`;
        textElement.textContent = entry.message;
        log.prepend(element);
        state.history.push(entry);
        state.history = state.history.slice(-40);
      }

      function pushLog(message, emoji = "â¨") {
        const entry = { emoji, message, timestamp: Date.now() };
        addLogEntry(entry);
        saveState();
      }

      function showToast(emoji, message) {
        toastEmoji.textContent = emoji;
        toastMessage.textContent = message;
        toast.classList.add("show");
        clearTimeout(showToast.timeoutId);
        showToast.timeoutId = setTimeout(() => {
          toast.classList.remove("show");
        }, 3200);
      }

      function clamp(value, min, max) {
        return Math.min(Math.max(value, min), max);
      }

      function createSoundEngine() {
        const AudioContextClass = window.AudioContext || window.webkitAudioContext;
        if (!AudioContextClass) {
          return null;
        }
        let context;
        let masterGain;

        function ensureContext() {
          if (context) return context;
          try {
            context = new AudioContextClass();
            masterGain = context.createGain();
            masterGain.gain.value = 0.22;
            masterGain.connect(context.destination);
          } catch (error) {
            console.warn("AudioContext no disponible", error);
            context = null;
          }
          return context;
        }

        function playPattern(pattern) {
          const ctx = ensureContext();
          if (!ctx || !Array.isArray(pattern)) return;
          if (ctx.state === "suspended") {
            ctx.resume();
          }
          let time = ctx.currentTime + 0.05;
          pattern.forEach((tone) => {
            if (!tone) return;
            const {
              freq,
              duration = 0.2,
              type = "sine",
              volume = 0.6,
              delay = 0,
              slide = 0,
            } = tone;
            time += delay;
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.type = type;
            oscillator.frequency.setValueAtTime(freq, time);
            if (slide !== 0) {
              const targetFreq = freq + slide;
              oscillator.frequency.linearRampToValueAtTime(
                targetFreq,
                time + Math.max(duration - 0.02, 0.01)
              );
            }
            const peakTime = time + Math.min(duration * 0.35, 0.12);
            gainNode.gain.setValueAtTime(0.0001, time);
            gainNode.gain.linearRampToValueAtTime(volume, peakTime);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, time + duration + 0.04);
            oscillator.connect(gainNode);
            gainNode.connect(masterGain);
            oscillator.start(time);
            oscillator.stop(time + duration + 0.1);
            time += duration;
          });
        }

        return {
          playPattern,
        };
      }

      function toggleAccessory(show) {
        const accessory = document.getElementById("accessory");
        accessory.style.opacity = show ? 1 : 0;
      }

      function toggleDayMode() {
        state.dayMode = state.dayMode === "day" ? "night" : "day";
        updateDayMode();
        saveState();
        pushLog(`El entorno cambia a modo ${state.dayMode === "day" ? "dÃ­a" : "noche"}.`, "ð");
      }

      function updateDayMode() {
        document.body.dataset.mode = state.dayMode;
        if (state.dayMode === "day") {
          document.documentElement.style.setProperty(
            "--bg-primary",
            "radial-gradient(circle at top, #ffe3f1 0%, #ffb7d5 36%, #ff86c6 70%, #f564a5 100%)"
          );
          dayEmoji.textContent = "ð";
          dayLabel.textContent = "Parque soleado";
          degradeRates = { ...baseDegradeRates };
        } else {
          document.documentElement.style.setProperty(
            "--bg-primary",
            "radial-gradient(circle at top, #2b1b68 0%, #1d0f51 42%, #10063a 75%, #040019 100%)"
          );
          dayEmoji.textContent = "ð";
          dayLabel.textContent = "Noche estrellada";
          degradeRates = { ...baseDegradeRates, energy: -1.4 };
        }
      }

      function getName() {
        const fallbackSkin = catSkins[currentSkinIndex] ?? catSkins[0];
        return state.name || fallbackSkin?.name || "Pixel";
      }

      function startCatWander() {
        if (wanderIntervalId) clearInterval(wanderIntervalId);
        wanderIntervalId = setInterval(() => wanderCat(), 4200);
        wanderCat(true);
      }

      function wanderCat(force = false) {
        if (!catScene || !catWanderer) return;
        const sceneWidth = catScene.clientWidth;
        const catWidth = catWanderer.offsetWidth || 1;
        const maxOffset = (sceneWidth - catWidth) / 2 - 12;
        if (maxOffset <= 0) return;
        let newX = (Math.random() * 2 - 1) * maxOffset;
        const delta = Math.abs(newX - catMotion.x);
        if (!force && delta < sceneWidth * 0.1) {
          newX = Math.sign(newX || 1) * Math.min(maxOffset, Math.abs(newX) + sceneWidth * 0.18);
        }
        const newY = -Math.random() * 18;
        const direction = newX < catMotion.x ? -1 : 1;
        catMotion.x = newX;
        catMotion.y = newY;
        catWanderer.style.setProperty("--x", `${newX}px`);
        catWanderer.style.setProperty("--y", `${newY}px`);
        catWanderer.style.setProperty("--flip", direction === -1 ? "-1" : "1");
      }

      window.addEventListener("visibilitychange", () => {
        state.lastTick = Date.now();
      });

      window.addEventListener("beforeunload", saveState);
    </script>
  </body>
</html>
